#!/system/bin/sh

LOGFILE=/data/local/tmp/magiskd-helper.log
RETRIES=0

magiskd_chk() {
  pgrep magiskd  >/dev/null
}

rm -f $LOGFILE
echo "Started " $(date) >> $LOGFILE
echo "-----------------------------" >> $LOGFILE
echo >> $LOGFILE

while true; do
   sleep 1
      if ! magiskd_chk; then
         echo $(date) >> $LOGFILE
         echo "Magisk daemon appears to have crashed" >> $LOGFILE
         echo "Restarting magiskd..." >> $LOGFILE
         
         if magisk --daemon; then
            echo "success!" >> $LOGFILE
            echo >> $LOGFILE 
         else 
            echo "failure!" >> $LOGFILE
            echo >> $LOGFILE
            RETRIES=$RETRIES+1
         fi
         
         if [[ $RETRIES -eq 10 ]]; then
            echo "giving up!" >> $LOGFILE
            echo >> $LOGFILE 
            exit 0
         fi
      fi
done
